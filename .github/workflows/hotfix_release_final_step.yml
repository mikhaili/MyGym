name: Release and Notify

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Get inputs
        run: |
          echo "VERSION_NUMBER=${{ inputs.version_number }}"
          echo "RECIPIENT_LIST=${{ inputs.recipient_list }}"
          echo "SLACK_CHANNEL=${{ inputs.slack_channel }}"
      - name: Merge release branch to master
        run: |
          git checkout master
          git fetch origin
          git merge origin/release
          if [ $? -ne 0 ]; then
            echo "Merge conflicts detected! Please resolve them and try again."
            exit 1
          fi
      - name: Tag the release version
        run: |
          git tag -a v${{ inputs.version_number }} -m "Release v${{ inputs.version_number }}"
      - name: Push changes to remote
        run: git push origin master --tags
      - name: Merge release branch to develop (optional)
        if: startsWith(github.ref, 'refs/heads/develop')
        steps:
        - name: Checkout develop branch
          run: git checkout develop
        - name: Merge origin/release
          run: |
            git merge origin/release
            if [ $? -ne 0 ]; then
              echo "Merge conflicts detected! Please resolve them and try again."
              exit 1
            fi
      - name: Generate release notes
        run: |
          # Use your preferred method for generating release notes
          git-chglog > release_notes.txt
      - name: Send notification emails
        if: ${{ inputs.recipient_list }}
        run: |
          cat release_notes.txt | mail -s "Version v${{ inputs.version_number }} Released!" "${{ inputs.recipient_list }}"
      - name: Send Slack notification (if channel provided)
        if: ${{ inputs.slack_channel }}
        run: |
          curl -X POST -H 'Content-Type: application/json' -d '{"text": "Version v${{ inputs.version_number }} has been released in channel #${{ inputs.slack_channel }}! See release notes:\n<release_notes_url>"}' "${{ inputs.slack_channel }}"
      - name: Clean up
        run: git checkout master
      - name: Success message
        run: echo "Version v${{ inputs.version_number }} has been successfully released!"

inputs:
  version_number:
    description: Release version number
    required: true
  recipient_list:
    description: Comma-separated list of email addresses to notify
    required: false
  slack_channel:
    description: Slack channel to notify (without # symbol)
    required: false

